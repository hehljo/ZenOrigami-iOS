name: iOS Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test Swift Package
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: |
        xcodebuild -version
        swift --version

    - name: Resolve Swift Dependencies
      run: swift package resolve

    - name: Build Swift Package
      run: swift build -v

    - name: Run Tests
      run: swift test -v

  syntax-check:
    name: Swift Syntax Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Swift Syntax
      run: |
        echo "ðŸ” Checking Swift syntax..."
        # Find all Swift files and validate syntax
        find ZenOrigami Tests -name "*.swift" -type f 2>/dev/null | while read file; do
          echo "Checking: $file"
          swiftc -typecheck "$file" -sdk $(xcrun --show-sdk-path --sdk macosx) || exit 1
        done
        echo "âœ… All Swift files have valid syntax"

  lint:
    name: SwiftLint
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint lint --reporter github-actions-logging || true

  security-check:
    name: Security Audit
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for hardcoded secrets
      run: |
        echo "ðŸ”’ Checking for potential secrets..."

        # Check for API keys, tokens, passwords
        if grep -r -i "apikey\|api_key\|token.*=.*[\"']\|password.*=.*[\"']\|secret.*=.*[\"']" --include="*.swift" ZenOrigami/ 2>/dev/null | grep -v "//"; then
          echo "âš ï¸ Found potential hardcoded secrets - review carefully"
          exit 0  # Warning, not error
        else
          echo "âœ… No hardcoded secrets found"
        fi

        # Check for URLs with credentials
        if grep -r "https://.*:.*@" --include="*.swift" ZenOrigami/ 2>/dev/null; then
          echo "âš ï¸ Found URLs with credentials - use secure credential storage"
          exit 1
        fi

  package-info:
    name: Package Information
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Package Info
      run: |
        echo "ðŸ“¦ Package Information:"
        echo "====================="

        # Count Swift files
        SWIFT_FILES=$(find . -name "*.swift" -type f 2>/dev/null | wc -l | xargs)
        echo "Swift files: $SWIFT_FILES"

        # Count lines of code
        TOTAL_LINES=$(find . -name "*.swift" -type f -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
        echo "Total lines: $TOTAL_LINES"

        # Show dependencies
        echo ""
        echo "ðŸ“š Dependencies:"
        grep -A 10 "dependencies:" Package.swift || echo "No dependencies found"

        echo ""
        echo "âœ… Build statistics complete"
